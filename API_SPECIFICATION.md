# AI 角色扮演语音通话 - 后端接口规范

## 概述

本文档描述了前端与后端进行实时语音通话所需的接口规范。前端使用 WebSocket 连接与后端进行实时音频流传输。

## WebSocket 连接

### 连接地址
```
ws://localhost:8000/ws/voice-call/{role_id}
```

### 连接参数
- `role_id`: 角色ID，用于标识与哪个AI角色进行通话

### 连接流程
1. 前端发起 WebSocket 连接
2. 后端验证角色ID并建立连接
3. 开始实时音频流传输

## 音频数据格式

### 发送格式 (前端 → 后端)
- **格式**: PCM 16-bit 单声道
- **采样率**: 16000 Hz
- **数据**: ArrayBuffer 格式的原始音频数据
- **传输**: 每 4096 个样本发送一次

### 接收格式 (后端 → 前端)
- **格式**: PCM 16-bit 单声道或压缩音频
- **采样率**: 16000 Hz
- **数据**: ArrayBuffer 格式的音频数据
- **传输**: 实时流式传输

## 消息协议

### 音频数据消息
```json
{
  "type": "audio",
  "data": "<ArrayBuffer>",
  "timestamp": 1234567890
}
```

### 状态消息
```json
{
  "type": "status",
  "data": {
    "state": "connected|disconnected|error",
    "message": "状态描述"
  },
  "timestamp": 1234567890
}
```

### 错误消息
```json
{
  "type": "error",
  "data": {
    "code": "ERROR_CODE",
    "message": "错误描述"
  },
  "timestamp": 1234567890
}
```

## 音频处理要求

### 音频预处理
- **回声消除**: 启用
- **噪声抑制**: 启用
- **自动增益控制**: 启用

### 实时性要求
- **延迟**: < 200ms
- **丢包率**: < 1%
- **带宽**: 建议 64kbps 以上

## 错误处理

### 连接错误
- 角色ID无效
- 网络连接失败
- 服务器过载

### 音频错误
- 音频格式不支持
- 音频质量过低
- 传输中断

## 安全考虑

### 权限验证
- 验证用户身份
- 验证角色访问权限
- 限制连接数量

### 数据保护
- 音频数据加密传输
- 敏感信息过滤
- 连接日志记录

## 性能优化

### 音频优化
- 自适应比特率
- 音频压缩
- 缓存优化

### 网络优化
- 连接池管理
- 负载均衡
- 故障转移

## 测试建议

### 功能测试
- 连接建立和断开
- 音频传输质量
- 错误处理机制

### 性能测试
- 并发连接数
- 音频延迟测试
- 资源使用情况

### 兼容性测试
- 不同浏览器支持
- 移动端适配
- 网络环境测试
