# Vox Backend API 接口文档

## 基础信息

- **基础URL**: `http://localhost:8080`
- **认证方式**: JWT Token (Bearer Token)
- **Content-Type**: `application/json`

## 认证接口

### 1. 用户注册
- **URL**: `POST /auth/register`
- **认证**: 无需认证
- **请求体**:
```json
{
  "username": "testuser",
  "password": "password123"
}
```
- **响应**:
```json
{
  "message": "User registered successfully",
  "user_id": 1
}
```

### 2. 用户登录
- **URL**: `POST /auth/login`
- **认证**: 无需认证
- **请求体**:
```json
{
  "username": "testuser",
  "password": "password123"
}
```
- **响应**:
```json
{
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

## API 接口 (需要认证)

> **注意**: 以下接口都需要在请求头中包含 JWT Token
> ```
> Authorization: Bearer <your_jwt_token>
> ```

### 3. 获取角色列表
- **URL**: `GET /api/v1/characters`
- **认证**: 需要 JWT Token
- **响应**:
```json
{
  "data": [
    {
      "ID": 1,
      "name": "哈利·波特",
      "description": "霍格沃茨魔法学校的学生，擅长黑魔法防御术。",
      "system_prompt": "你是一个15岁的哈利·波特..."
    }
  ]
}
```

### 4. 文字聊天
- **URL**: `POST /api/v1/chat`
- **认证**: 需要 JWT Token
- **请求体**:
```json
{
  "character_id": 1,
  "new_message": "你好，哈利！"
}
```
- **响应**:
```json
{
  "response": "你好！我是哈利·波特，很高兴见到你！"
}
```

### 5. 语音聊天
- **URL**: `POST /api/v1/voice/chat`
- **认证**: 需要 JWT Token
- **请求体**:
```json
{
  "character_id": 1,
  "audio_url": "http://example.com/audio.mp3",
  "audio_format": "mp3",
  "voice_id": "qiniu_zh_female_tmjxxy"
}
```
- **响应**: 音频流 (Content-Type: audio/mpeg)
- **响应头**:
```
X-Transcribed-Text: 你好哈利
X-AI-Text-Response: 你好！我是哈利·波特
```

### 6. 语音转文字
- **URL**: `POST /api/v1/transcribe`
- **认证**: 需要 JWT Token
- **请求体**:
```json
{
  "audio_url": "http://example.com/audio.mp3",
  "audio_format": "mp3"
}
```
- **响应**:
```json
{
  "text": "你好，我是用户"
}
```

### 7. 文字转语音
- **URL**: `POST /api/v1/tts`
- **认证**: 需要 JWT Token
- **请求体**:
```json
{
  "text": "你好，我是AI助手",
  "voice_id": "qiniu_zh_female_tmjxxy"
}
```
- **响应**: 音频流 (Content-Type: audio/mpeg)

### 8. 获取聊天历史
- **URL**: `GET /api/v1/history/:user_id/:character_id`
- **认证**: 需要 JWT Token
- **参数**:
  - `user_id`: 用户ID (从JWT Token中获取)
  - `character_id`: 角色ID
- **响应**:
```json
{
  "history": [
    {
      "user_message": "你好哈利",
      "ai_message": "你好！我是哈利·波特",
      "timestamp": 1695888000
    }
  ]
}
```

## 错误响应格式

```json
{
  "error": "错误描述信息"
}
```

## 常见错误码

- `400 Bad Request`: 请求参数错误
- `401 Unauthorized`: 未认证或Token无效
- `404 Not Found`: 资源不存在
- `500 Internal Server Error`: 服务器内部错误

## 测试用户

系统会自动创建测试用户：
- **用户名**: `testuser`
- **密码**: `password123`

## 认证测试流程

### 1. 测试未认证访问 (应该失败)
```bash
curl -X GET http://localhost:8080/api/v1/characters
```
**预期结果**: 状态码 401 Unauthorized，提示 "Authorization header required"

### 2. 登录获取Token
```bash
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123"
  }'
```

### 3. 使用Token访问 (应该成功)
```bash
curl -X GET http://localhost:8080/api/v1/characters \
  -H "Authorization: Bearer <从步骤2获取的token>"
```
**预期结果**: 状态码 200 OK，返回角色列表

## 使用示例

### 1. 登录获取Token
```bash
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "password123"
  }'
```

### 2. 获取角色列表
```bash
curl -X GET http://localhost:8080/api/v1/characters \
  -H "Authorization: Bearer <your_jwt_token>"
```

### 3. 使用Token进行聊天
```bash
curl -X POST http://localhost:8080/api/v1/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your_jwt_token>" \
  -d '{
    "character_id": 1,
    "new_message": "你好！"
  }'
```

### 4. 获取聊天历史
```bash
curl -X GET http://localhost:8080/api/v1/history/1/1 \
  -H "Authorization: Bearer <your_jwt_token>"
```
